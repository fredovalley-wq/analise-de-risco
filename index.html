<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Risco - Polícia Penal RS</title>
    
    <!-- 1. Tailwind CSS (Estilos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. html2pdf (Gerador de PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- 3. Configuração para Importar React e Lucide direto do navegador -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    
    <!-- 4. Babel (Para entender o código React/JSX no navegador) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Ajustes finos para impressão que o Tailwind as vezes perde */
        @media print {
            body { -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-gray-100 text-slate-800">
    <div id="root"></div>

    <!-- CÓDIGO DA APLICAÇÃO -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, 
            Trash2, 
            Printer, 
            RefreshCw, 
            ShieldAlert, 
            FileText, 
            BrainCircuit, 
            CheckCircle2,
            Eraser,
            Download
        } from 'lucide-react';

        /* --- CONFIGURAÇÃO DA API --- */
        // CHAVE INSERIDA
        const apiKey = "AIzaSyAw0YNxOottL5lhUyyJrnS_zX1id7SQtSM"; 

        const PROBABILITY_LABELS_MAP = {
            5: 'Muito Alta',
            4: 'Alta',
            3: 'Média',
            2: 'Baixa',
            1: 'Muito Baixa'
        };

        const IMPACT_LABELS_MAP = {
            1: 'Insignificante',
            2: 'Menor',
            3: 'Moderado',
            4: 'Maior',
            5: 'Catastrófico'
        };

        const PROBABILITY_OPTIONS = Object.entries(PROBABILITY_LABELS_MAP).sort((a,b) => b[0] - a[0]); 
        const IMPACT_OPTIONS = Object.entries(IMPACT_LABELS_MAP).sort((a,b) => a[0] - b[0]);

        const W2H_QUESTIONS = [
            { key: 'what', label: 'O Que' },
            { key: 'why', label: 'Por Que' },
            { key: 'where', label: 'Onde' },
            { key: 'when', label: 'Quando' },
            { key: 'who', label: 'Quem' },
            { key: 'how', label: 'Como' },
            { key: 'how_much', label: 'Quanto' },
        ];

        function App() {
            const [docTitle, setDocTitle] = useState('');
            const [docRef, setDocRef] = useState('');
            const [docDate, setDocDate] = useState(new Date().toISOString().split('T')[0]);
            
            const [risks, setRisks] = useState([]);
            const [currentRisk, setCurrentRisk] = useState({ title: '', description: '', prob: 1, impact: 1 });
            
            const [actionPlans, setActionPlans] = useState([]);
            const [selectedRiskIdForAction, setSelectedRiskIdForAction] = useState('');
            
            const [conclusion, setConclusion] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [isGeneratingConclusion, setIsGeneratingConclusion] = useState(false);
            const [isPdfLibReady, setIsPdfLibReady] = useState(false);
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);

            const contentRef = useRef(null);

            useEffect(() => {
                // Verifica se html2pdf carregou
                if (window.html2pdf) setIsPdfLibReady(true);
            }, []);

            // --- Helpers ---
            const calculateRiskLevel = (prob, impact) => prob * impact;
            
            const getRiskColor = (level) => {
                if (level <= 4) return 'bg-green-600 text-white border-green-800';
                if (level <= 9) return 'bg-yellow-500 text-slate-900 border-yellow-700';
                if (level <= 14) return 'bg-orange-500 text-white border-orange-700';
                return 'bg-red-600 text-white border-red-800';
            };

            const getRiskRowBgColor = (level) => {
                if (level <= 4) return 'bg-green-50 hover:bg-green-100';
                if (level <= 9) return 'bg-yellow-50 hover:bg-yellow-100';
                if (level <= 14) return 'bg-orange-50 hover:bg-orange-100';
                return 'bg-red-50 hover:bg-red-100';
            };

            const getMatrixCellColor = (level) => {
                if (level <= 4) return 'bg-green-600 hover:bg-green-500 text-white';
                if (level <= 9) return 'bg-yellow-400 hover:bg-yellow-300 text-slate-900';
                if (level <= 14) return 'bg-orange-500 hover:bg-orange-400 text-white';
                return 'bg-red-600 hover:bg-red-500 text-white';
            };

            const getRiskLabel = (level) => {
                if (level <= 4) return 'Baixo';
                if (level <= 9) return 'Médio';
                if (level <= 14) return 'Alto';
                return 'Extremo';
            };

            // --- Handlers ---
            const handleAddRisk = () => {
                if (!currentRisk.title || !currentRisk.description) {
                    alert("Por favor, preencha o título e a descrição do risco.");
                    return;
                }
                const newRisk = {
                    id: Date.now().toString(),
                    ...currentRisk,
                    level: calculateRiskLevel(currentRisk.prob, currentRisk.impact)
                };
                setRisks([...risks, newRisk]);
                setCurrentRisk({ title: '', description: '', prob: 1, impact: 1 });
            };

            const handleDeleteRisk = (id) => {
                if(confirm("Tem certeza que deseja excluir este risco e seu plano de ação?")) {
                    setRisks(risks.filter(r => r.id !== id));
                    setActionPlans(actionPlans.filter(ap => ap.riskId !== id));
                }
            };

            const handleUpdateRisk = (id, field, value) => {
                setRisks(risks.map(risk => {
                    if (risk.id === id) {
                        const updatedRisk = { ...risk, [field]: value };
                        if (field === 'prob' || field === 'impact') {
                            updatedRisk.level = calculateRiskLevel(updatedRisk.prob, updatedRisk.impact);
                        }
                        return updatedRisk;
                    }
                    return risk;
                }));
                if (field === 'title') {
                    setActionPlans(actionPlans.map(ap => ap.riskId === id ? { ...ap, riskTitle: value } : ap));
                }
            };

            const handleUpdateActionPlan = (planId, field, value) => {
                setActionPlans(actionPlans.map(plan => 
                    plan.id === planId ? { ...plan, [field]: value } : plan
                ));
            };

            const handleClearAll = () => {
                if(confirm("Tem certeza que deseja apagar todo o relatório?")) {
                    setRisks([]);
                    setActionPlans([]);
                    setConclusion('');
                    setDocTitle('');
                    setDocRef('');
                }
            };

            const handleGeneratePdf = () => {
                if (!isPdfLibReady || !window.html2pdf) {
                    alert("O gerador de PDF está carregando... Aguarde alguns segundos e tente novamente.");
                    return;
                }

                setIsGeneratingPdf(true);
                const element = contentRef.current;
                
                const opt = {
                    margin:       [10, 10, 15, 10], 
                    filename:     `${docTitle || 'relatorio_inteligencia'}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    pagebreak:    { mode: ['css', 'legacy'] },
                    html2canvas:  { 
                        scale: 2, 
                        useCORS: true,
                        scrollY: 0, 
                        letterRendering: true,
                        backgroundColor: null,
                        onclone: (clonedDoc) => {
                            const elementsToHide = clonedDoc.querySelectorAll('.print\\:hidden');
                            elementsToHide.forEach(el => el.style.display = 'none');
                            
                            const style = clonedDoc.createElement('style');
                            style.innerHTML = `
                                #pdf-root-container { background-color: white; }
                                #main-content { padding: 10px !important; gap: 5px !important; display: block !important; position: relative !important; z-index: 10 !important; }
                                #section-1-container { display: flex !important; flex-direction: row !important; gap: 10px !important; width: 100% !important; align-items: flex-start !important; }
                                #left-column { width: 40% !important; margin: 0 !important; }
                                #right-column { width: 60% !important; margin: 0 !important; }
                                #risks-table-container { margin: 0 !important; }
                                #matrix-container { margin: 0 !important; width: 100% !important; }
                                #action-plan-section { 
                                    display: block !important; 
                                    page-break-before: always !important; 
                                    break-before: page !important;
                                    margin-top: 30px !important;
                                }
                                .overflow-x-auto { overflow: visible !important; display: block !important; width: 100% !important; }
                                table { font-size: 9px !important; width: 100% !important; page-break-inside: auto !important; background-color: white !important; }
                                thead { display: table-header-group !important; }
                                tr { page-break-inside: avoid !important; }
                                td, th { page-break-inside: avoid !important; }
                                h3, h4 { margin-top: 0 !important; margin-bottom: 5px !important; }
                                textarea { border: none !important; resize: none !important; padding: 0 !important; background: transparent !important; }
                                input { border: none !important; padding: 0 !important; background: transparent !important; }
                            `;
                            clonedDoc.body.appendChild(style);

                            const inputs = clonedDoc.querySelectorAll('input');
                            inputs.forEach(input => {
                                if(input.type === 'text' || input.type === 'date') {
                                    input.style.border = 'none';
                                    input.style.padding = '0';
                                    input.style.backgroundColor = 'transparent';
                                }
                            });

                            const textareas = clonedDoc.querySelectorAll('textarea');
                            textareas.forEach(ta => {
                                const div = document.createElement('div');
                                div.innerText = ta.value;
                                div.style.whiteSpace = 'pre-wrap';
                                div.style.wordWrap = 'break-word';
                                div.style.fontSize = window.getComputedStyle(ta).fontSize;
                                div.style.fontFamily = window.getComputedStyle(ta).fontFamily;
                                div.style.textAlign = window.getComputedStyle(ta).textAlign;
                                div.style.width = '100%';
                                if (ta.closest('td')) { div.style.overflow = 'visible'; }
                                ta.parentNode.replaceChild(div, ta);
                            });
                            
                            const inputForm = clonedDoc.getElementById('risk-input-form');
                            if (inputForm) inputForm.remove(); 

                            const matrixWrapper = clonedDoc.getElementById('matrix-content-wrapper');
                            if (matrixWrapper) {
                                matrixWrapper.style.display = 'block'; 
                                matrixWrapper.style.gridTemplateColumns = 'none';
                                matrixWrapper.style.margin = '0px';
                                matrixWrapper.style.padding = '0px';
                                matrixWrapper.style.gap = '0px';
                                matrixWrapper.style.border = 'none';
                            }

                            const matrixContainer = clonedDoc.getElementById('matrix-container');
                            if (matrixContainer) {
                                matrixContainer.style.width = '100%';
                                matrixContainer.style.maxWidth = '100%';
                                matrixContainer.style.marginTop = '20px'; 
                                matrixContainer.style.paddingTop = '0px';
                                matrixContainer.style.display = 'block';
                            }
                        }
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                window.html2pdf().from(element).set(opt).toPdf().get('pdf').then((pdf) => {
                    const totalPages = pdf.internal.getNumberOfPages();
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    
                    for (let i = 1; i <= totalPages; i++) {
                        pdf.setPage(i);
                        pdf.setFontSize(8);
                        pdf.setTextColor(180, 0, 0); 
                        pdf.text('DOCUMENTO PREPARATÓRIO - ACESSO RESTRITO', pageWidth / 2, pageHeight - 8, { align: 'center' });
                    }
                }).save().then(() => {
                    setIsGeneratingPdf(false);
                }).catch(err => {
                    console.error(err);
                    setIsGeneratingPdf(false);
                    alert("Erro ao gerar PDF.");
                });
            };

            const generateActionPlan = async () => {
                if (!selectedRiskIdForAction) return;
                setIsGenerating(true);
                const riskToAnalyze = risks.find(r => r.id === selectedRiskIdForAction);
                try {
                    const prompt = `Aja como um especialista em Inteligência Penitenciária. Crie um plano de ação 5W2H conciso (máx 140 chars/campo) para o risco: "${riskToAnalyze.title}" - ${riskToAnalyze.description} (Nível: ${getRiskLabel(riskToAnalyze.level)}). Retorne APENAS um JSON válido: { "what": "O que", "why": "Por que", "where": "Onde", "when": "Quando", "who": "Quem", "how": "Como", "how_much": "Custo" }`;
                    
                    // MUDANÇA: Modelo alterado para gemini-1.5-flash (mais estável para chaves públicas)
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `Erro HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("Resposta da IA vazia");
                    text = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
                    const plan = JSON.parse(text);
                    setActionPlans([...actionPlans, { id: Date.now().toString(), riskId: riskToAnalyze.id, riskTitle: riskToAnalyze.title, ...plan }]);
                    setSelectedRiskIdForAction('');
                } catch (error) { 
                    console.error("Erro IA:", error); 
                    // MUDANÇA: Alerta mais detalhado para ajudar no debug
                    alert(`Erro ao gerar plano:\n${error.message}\n\nVerifique se a chave API está correta.`); 
                } finally { 
                    setIsGenerating(false); 
                }
            };

            const generateConclusion = async () => {
                if (risks.length === 0) return;
                setIsGeneratingConclusion(true);
                try {
                    const risksText = risks.map(r => `- ${r.title} (Nível: ${getRiskLabel(r.level)})`).join('\n');
                    const actionsText = actionPlans.map(a => `- Ação: ${a.what}`).join('\n');
                    const prompt = `Escreva uma conclusão técnica concisa para um relatório de inteligência penitenciária. Título: ${docTitle}. Riscos: ${risksText}. Ações: ${actionsText}. Use linguagem formal. Máximo 1 parágrafo.`;
                    
                    // MUDANÇA: Modelo alterado para gemini-1.5-flash
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `Erro HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("Resposta da IA vazia");
                    setConclusion(text);
                } catch (error) { 
                    console.error("Erro IA:", error); 
                    // MUDANÇA: Alerta mais detalhado para ajudar no debug
                    alert(`Erro ao gerar conclusão:\n${error.message}`); 
                } finally { 
                    setIsGeneratingConclusion(false); 
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 p-4 md:p-8 font-sans text-slate-800">
                    <div ref={contentRef} className="max-w-7xl mx-auto bg-white shadow-xl min-h-[29.7cm] relative z-10 p-0 overflow-hidden" id="pdf-root-container">
                        
                        <header className="border-b-4 border-yellow-500 p-6 flex flex-col items-center justify-center gap-1 text-center relative z-20">
                            <h1 className="text-xl md:text-2xl font-extrabold text-slate-900 uppercase tracking-widest">
                                Polícia Penal do Rio Grande do Sul
                            </h1>
                            <h2 className="text-base md:text-lg font-bold text-slate-700 uppercase tracking-wide">
                                Departamento de Inteligência
                            </h2>
                            <h3 className="text-sm md:text-base font-medium text-slate-600 uppercase border-t border-slate-300 pt-1 w-full max-w-lg">
                                Ferramenta de Análise de Risco
                            </h3>
                        </header>

                        <div className="p-6 bg-slate-50 border-b border-slate-200 relative z-20">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Título do Documento / Operação</label>
                                    <input 
                                        type="text" 
                                        value={docTitle}
                                        onChange={(e) => setDocTitle(e.target.value)}
                                        placeholder="Ex: Operação Muralha"
                                        className="w-full p-1 border border-slate-300 rounded focus:border-blue-600 outline-none bg-white font-semibold text-base"
                                    />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Documento de Referência</label>
                                        <input 
                                            type="text" 
                                            value={docRef}
                                            onChange={(e) => setDocRef(e.target.value)}
                                            placeholder="Ex: RELINT Nº XXXX-2026"
                                            className="w-full p-1 border border-slate-300 rounded focus:border-blue-600 outline-none bg-white text-sm"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Data da Produção</label>
                                        <input 
                                            type="date" 
                                            value={docDate}
                                            onChange={(e) => setDocDate(e.target.value)}
                                            className="w-full p-1 border border-slate-300 rounded focus:border-blue-600 outline-none bg-white text-sm"
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <main id="main-content" className="p-6 space-y-4 relative z-20">
                            
                            <section id="matrix-section">
                                <div id="matrix-header" className="flex items-center gap-2 mb-4 border-b border-slate-300">
                                    <ShieldAlert className="w-5 h-5 text-blue-800" />
                                    <h3 className="text-base font-bold text-slate-800 uppercase py-1">1. Análise de Risco</h3>
                                </div>

                                <div id="section-1-container" className="flex flex-col xl:flex-row gap-6 items-start">
                                    
                                    <div id="left-column" className="w-full xl:w-5/12 flex flex-col gap-4">
                                        
                                        <div id="risks-table-container">
                                            <h4 className="text-xs font-bold text-slate-700 uppercase mb-2 border-b border-slate-200">Riscos Identificados</h4>
                                            <div className="overflow-x-auto rounded border border-slate-200">
                                            <table className="w-full text-xs text-left text-slate-700">
                                                <thead className="bg-slate-100 uppercase font-bold text-[10px]">
                                                <tr>
                                                    <th className="px-2 py-1 border-b">Título / Descrição</th>
                                                    <th className="px-2 py-1 border-b w-16">Prob.</th>
                                                    <th className="px-2 py-1 border-b w-16">Imp.</th>
                                                    <th className="px-2 py-1 border-b text-center w-8 print:hidden">X</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                {risks.length === 0 && (
                                                    <tr><td colSpan="5" className="px-2 py-4 text-center text-slate-400 text-[10px]">Sem riscos.</td></tr>
                                                )}
                                                {risks.map((risk) => (
                                                    <tr key={risk.id} className={`border-b ${getRiskRowBgColor(risk.level)} text-[10px]`}>
                                                    <td className="px-2 py-1 align-top">
                                                        <div className="font-bold text-slate-800">{risk.title}</div>
                                                        <div className="text-slate-600 text-[9px] mt-0.5 leading-tight">{risk.description}</div>
                                                    </td>
                                                    <td className="px-2 py-1 align-top text-slate-700 font-medium">
                                                        {PROBABILITY_LABELS_MAP[risk.prob]}
                                                    </td>
                                                    <td className="px-2 py-1 align-top text-slate-700 font-medium">
                                                        {IMPACT_LABELS_MAP[risk.impact]}
                                                    </td>
                                                    <td className="px-2 py-1 text-center print:hidden align-top">
                                                        <button onClick={() => handleDeleteRisk(risk.id)} className="text-red-500"><Trash2 size={12} /></button>
                                                    </td>
                                                    </tr>
                                                ))}
                                                </tbody>
                                            </table>
                                            </div>
                                        </div>

                                        <div id="risk-input-form" className="bg-blue-50 p-3 rounded-lg border border-blue-100 print:hidden shadow-sm">
                                            <h4 className="font-bold text-blue-900 mb-2 text-xs uppercase flex items-center gap-2">
                                                <Plus size={14} /> Novo Risco
                                            </h4>
                                            
                                            <div className="space-y-2">
                                                <div>
                                                    <input 
                                                        type="text"
                                                        value={currentRisk.title}
                                                        onChange={(e) => setCurrentRisk({...currentRisk, title: e.target.value})}
                                                        placeholder="Título (Ex: Fuga)"
                                                        maxLength={30}
                                                        className="w-full p-1 text-xs border border-blue-200 rounded outline-none"
                                                    />
                                                </div>
                                                <div>
                                                    <textarea 
                                                        value={currentRisk.description}
                                                        onChange={(e) => setCurrentRisk({...currentRisk, description: e.target.value})}
                                                        placeholder="Descrição..."
                                                        className="w-full p-1 text-xs border border-blue-200 rounded resize-none h-12 outline-none"
                                                    />
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="block text-[9px] font-bold text-blue-800 mb-0.5 uppercase">Probabilidade</label>
                                                        <select 
                                                            value={currentRisk.prob}
                                                            onChange={(e) => setCurrentRisk({...currentRisk, prob: parseInt(e.target.value)})}
                                                            className="w-full p-1 text-xs border border-blue-200 rounded bg-white"
                                                        >
                                                            {PROBABILITY_OPTIONS.map(([val, label]) => <option key={val} value={val}>{label}</option>)}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-[9px] font-bold text-blue-800 mb-0.5 uppercase">Impacto</label>
                                                        <select 
                                                            value={currentRisk.impact}
                                                            onChange={(e) => setCurrentRisk({...currentRisk, impact: parseInt(e.target.value)})}
                                                            className="w-full p-1 text-xs border border-blue-200 rounded bg-white"
                                                        >
                                                            {IMPACT_OPTIONS.map(([val, label]) => <option key={val} value={val}>{label}</option>)}
                                                        </select>
                                                    </div>
                                                </div>
                                                <button onClick={handleAddRisk} className="w-full bg-blue-800 hover:bg-blue-900 text-white font-bold py-1.5 px-3 rounded uppercase text-[10px] shadow-sm mt-1">Adicionar</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="right-column" className="w-full xl:w-7/12">
                                        <div id="matrix-container" className="flex flex-col items-center justify-start w-full">
                                            <h4 className="text-xs font-bold text-slate-700 uppercase mb-2 w-full text-center border-b border-slate-200 pb-1">MATRIZ DE RISCO</h4>
                                            
                                            <div className="flex flex-row items-center justify-center w-full">
                                                <div className="h-64 flex items-center justify-center mr-2 w-4">
                                                    <span className="-rotate-90 whitespace-nowrap text-[9px] font-black uppercase tracking-widest text-slate-800">
                                                    Probabilidade
                                                    </span>
                                                </div>
                                                <div className="flex flex-col justify-between h-[300px] mr-1 text-[8px] font-bold text-slate-600 text-right py-4 w-16">
                                                    {PROBABILITY_OPTIONS.map(([val, label]) => (
                                                        <div key={val} className="flex items-center justify-end h-full leading-tight">{label}</div>
                                                    ))}
                                                </div>
                                                
                                                <div className="relative w-full">
                                                    <div className="grid grid-cols-5 gap-0.5 bg-slate-800 border-2 border-slate-800 p-0.5 w-full h-[300px] shadow-sm rounded-sm overflow-hidden">
                                                    {[5, 4, 3, 2, 1].map((prob) => (
                                                        <React.Fragment key={prob}>
                                                        {[1, 2, 3, 4, 5].map((impact) => {
                                                            const level = prob * impact;
                                                            const cellRisks = risks.filter(r => r.prob === prob && r.impact === impact);
                                                            const bgColor = getMatrixCellColor(level);
                                                            return (
                                                            <div key={`${prob}-${impact}`} className={`relative flex flex-col items-center justify-start p-0.5 text-[8px] font-bold ${bgColor} overflow-hidden group`}>
                                                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-20 z-0">
                                                                <span className="text-2xl font-black text-black/50 mix-blend-overlay">{level}</span>
                                                                </div>
                                                                {cellRisks.length > 0 && (
                                                                <div className="w-full flex flex-col gap-0.5 z-10 relative h-full overflow-hidden p-0.5">
                                                                    {cellRisks.map((risk, idx) => (
                                                                    <div key={idx} className="bg-slate-900/90 text-white px-0.5 py-0 rounded text-[7px] font-bold leading-tight text-center break-words w-full shadow-sm">
                                                                        {risk.title}
                                                                    </div>
                                                                    ))}
                                                                </div>
                                                                )}
                                                            </div>
                                                            );
                                                        })}
                                                        </React.Fragment>
                                                    ))}
                                                    </div>
                                                    <div className="grid grid-cols-5 mt-1 text-center text-[8px] font-bold text-slate-600 w-full">
                                                        {IMPACT_OPTIONS.map(([val, label]) => (
                                                            <div key={val} className="flex flex-col items-center justify-start h-8 px-1">
                                                                <span className="leading-tight">{label}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="mt-1 text-center w-full pl-6">
                                                <span className="text-[9px] font-black uppercase tracking-widest text-slate-800">Impacto</span>
                                            </div>

                                            <div className="flex flex-wrap justify-center gap-3 mt-4 text-[9px] font-bold uppercase bg-white p-2 rounded-full shadow-sm border border-slate-200">
                                                <div className="flex items-center gap-1"><div className="w-3 h-3 bg-green-600"></div> Baixo</div>
                                                <div className="flex items-center gap-1"><div className="w-3 h-3 bg-yellow-400"></div> Médio</div>
                                                <div className="flex items-center gap-1"><div className="w-3 h-3 bg-orange-500"></div> Alto</div>
                                                <div className="flex items-center gap-1"><div className="w-3 h-3 bg-red-600"></div> Extremo</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section id="action-plan-section" className="mt-6">
                                <div id="action-plan-header" className="flex items-center gap-2 mb-2 border-b pb-1 border-slate-300">
                                    <CheckCircle2 className="w-5 h-5 text-blue-800" />
                                    <h3 className="text-base font-bold text-slate-800 uppercase">2. Plano de Ação (5W2H)</h3>
                                </div>

                                <div className="bg-slate-50 p-2 rounded border border-slate-200 mb-2 flex flex-col md:flex-row gap-2 items-center print:hidden">
                                    <select value={selectedRiskIdForAction} onChange={(e) => setSelectedRiskIdForAction(e.target.value)} className="w-full p-1 text-xs border rounded">
                                            <option value="">-- Selecione Risco --</option>
                                            {risks.filter(r => !actionPlans.some(ap => ap.riskId === r.id)).map(r => <option key={r.id} value={r.id}>{r.title}</option>)}
                                    </select>
                                    <button onClick={generateActionPlan} disabled={!selectedRiskIdForAction || isGenerating} className="w-full py-1 px-3 rounded text-white font-bold bg-indigo-600 text-xs flex justify-center gap-2">
                                        {isGenerating ? '...' : 'Gerar'}
                                    </button>
                                </div>

                                <div className="overflow-x-auto rounded border border-slate-200">
                                    {actionPlans.length === 0 ? (
                                        <div className="text-center py-4 bg-slate-50 text-slate-400 italic text-xs">Vazio</div>
                                    ) : (
                                        <table className="w-full text-[10px] text-left text-slate-700">
                                            <thead className="bg-slate-100 uppercase font-bold">
                                            <tr>
                                                <th className="px-2 py-1 border-b border-r bg-slate-200 w-20 text-center">Fator</th>
                                                {actionPlans.map((plan) => (
                                                    <th key={plan.id} className="px-2 py-1 border-b border-r min-w-[120px]">
                                                    <div className="flex justify-between items-center text-blue-800">
                                                        <span>{plan.riskTitle}</span>
                                                        <button onClick={() => handleDeleteRisk(plan.riskId)} className="text-red-400 print:hidden"><Trash2 size={10} /></button>
                                                    </div>
                                                    </th>
                                                ))}
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {W2H_QUESTIONS.map((question, qIdx) => (
                                                <tr key={question.key} className={qIdx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}>
                                                    <td className="px-2 py-1 border-b border-r font-bold bg-slate-100 text-center">{question.label}</td>
                                                    {actionPlans.map((plan) => (
                                                        <td key={`${plan.id}-${question.key}`} className="px-2 py-1 border-b border-r align-top">
                                                            <textarea
                                                                value={plan[question.key]}
                                                                onChange={(e) => handleUpdateActionPlan(plan.id, question.key, e.target.value)}
                                                                maxLength={150}
                                                                className="w-full bg-transparent outline-none resize-none overflow-hidden text-[10px] leading-tight"
                                                                rows={2}
                                                                style={{ minHeight: '20px' }}
                                                                onInput={(e) => { e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; }}
                                                            />
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                            </tbody>
                                        </table>
                                    )}
                                </div>
                            </section>

                            <section className="mt-6" style={{ pageBreakInside: 'avoid' }}>
                                <div className="flex items-center gap-2 mb-2 border-b pb-1 border-slate-300">
                                    <FileText className="w-5 h-5 text-blue-800" />
                                    <h3 className="text-base font-bold text-slate-800 uppercase">3. Conclusão</h3>
                                </div>
                                <div className="relative">
                                    <textarea 
                                            value={conclusion}
                                            onChange={(e) => setConclusion(e.target.value)}
                                            placeholder="Parecer..."
                                            className="w-full p-2 border border-slate-300 rounded text-justify text-xs leading-tight bg-white min-h-[100px]"
                                    />
                                    <div className="absolute bottom-2 right-2 print:hidden">
                                        <button onClick={generateConclusion} disabled={isGeneratingConclusion || risks.length === 0} className="bg-emerald-600 text-white text-[10px] font-bold py-1 px-2 rounded flex gap-1">IA</button>
                                    </div>
                                </div>
                            </section>

                        </main>
                        <footer className="bg-slate-800 text-white p-2 print:hidden flex justify-between items-center rounded-b mt-4">
                            <button onClick={handleClearAll} className="flex items-center gap-1 text-red-300 text-xs font-bold uppercase"><Eraser size={14} /> Limpar</button>
                            <button onClick={handleGeneratePdf} disabled={isGeneratingPdf} className="flex items-center gap-1 bg-yellow-500 text-slate-900 font-bold px-4 py-2 rounded text-xs uppercase disabled:opacity-50">
                                {isGeneratingPdf ? <RefreshCw className="animate-spin" size={14} /> : <Download size={14} />} {isGeneratingPdf ? '...' : 'PDF'}
                            </button>
                        </footer>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

