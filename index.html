<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Risco - Polícia Penal RS</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- 3. React e Lucide Importmap -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    
    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; }

        /* Animações para Modal e Toast */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }

        /* Ajustes de Impressão */
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Trash2, Printer, RefreshCw, ShieldAlert, FileText, 
            BrainCircuit, CheckCircle2, Eraser, Download, X, AlertTriangle, Settings, Key
        } from 'lucide-react';

        /* --- CONFIGURAÇÃO PADRÃO --- */
        // A chave anterior foi revogada. Deixe vazio para forçar o usuário a inserir a sua.
        const DEFAULT_API_KEY = "AIzaSyBOwoVr1dyR64PHZnHEepqRqXeZ_6HcWQE"; 

        const PROBABILITY_LABELS_MAP = {
            5: 'Muito Alta', 4: 'Alta', 3: 'Média', 2: 'Baixa', 1: 'Muito Baixa'
        };

        const IMPACT_LABELS_MAP = {
            1: 'Insignificante', 2: 'Menor', 3: 'Moderado', 4: 'Maior', 5: 'Catastrófico'
        };

        const PROBABILITY_OPTIONS = Object.entries(PROBABILITY_LABELS_MAP).sort((a,b) => b[0] - a[0]); 
        const IMPACT_OPTIONS = Object.entries(IMPACT_LABELS_MAP).sort((a,b) => a[0] - b[0]);

        const W2H_QUESTIONS = [
            { key: 'what', label: 'O Que' },
            { key: 'why', label: 'Por Que' },
            { key: 'where', label: 'Onde' },
            { key: 'when', label: 'Quando' },
            { key: 'who', label: 'Quem' },
            { key: 'how', label: 'Como' },
            { key: 'how_much', label: 'Quanto' },
        ];

        // --- COMPONENTES DE UI ---

        // Toast Notification
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 4000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgColors = {
                success: 'bg-emerald-600',
                error: 'bg-red-600',
                info: 'bg-blue-600'
            };

            return (
                <div className={`fixed top-4 right-4 z-50 ${bgColors[type] || bgColors.info} text-white px-4 py-3 rounded shadow-lg flex items-center gap-3 animate-slide-in max-w-sm`}>
                    <div className="text-sm font-medium">{message}</div>
                    <button onClick={onClose} className="hover:bg-white/20 rounded-full p-1"><X size={14} /></button>
                </div>
            );
        };

        // Modal de Confirmação
        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-md overflow-hidden">
                        <div className="bg-slate-100 px-4 py-3 border-b flex items-center gap-2">
                            <AlertTriangle className="text-orange-500" size={20} />
                            <h3 className="font-bold text-slate-800">{title}</h3>
                        </div>
                        <div className="p-4 text-slate-600 text-sm">
                            {message}
                        </div>
                        <div className="bg-slate-50 px-4 py-3 flex justify-end gap-2">
                            <button onClick={onCancel} className="px-3 py-1.5 rounded text-slate-600 hover:bg-slate-200 text-sm font-medium transition">Cancelar</button>
                            <button onClick={onConfirm} className="px-3 py-1.5 rounded bg-red-600 text-white hover:bg-red-700 text-sm font-bold shadow transition">Confirmar</button>
                        </div>
                    </div>
                </div>
            );
        };

        // Modal de Configuração (API Key)
        const SettingsModal = ({ isOpen, currentKey, onSave, onClose }) => {
            const [keyInput, setKeyInput] = useState(currentKey);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-md">
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2"><Settings size={18} /> Configurações</h3>
                            <button onClick={onClose}><X size={18} className="text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        <div className="p-6">
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Google Gemini API Key</label>
                            <div className="relative">
                                <Key className="absolute left-2 top-2 text-slate-400" size={16} />
                                <input 
                                    type="password" 
                                    value={keyInput} 
                                    onChange={(e) => setKeyInput(e.target.value)}
                                    className="w-full pl-8 pr-2 py-1.5 border rounded text-sm focus:border-blue-500 outline-none"
                                    placeholder="Cole sua chave AIza..."
                                />
                            </div>
                            <p className="text-[10px] text-slate-400 mt-2">A chave é necessária para gerar planos de ação e conclusões com IA.</p>
                        </div>
                        <div className="p-4 bg-slate-50 flex justify-end">
                            <button onClick={() => onSave(keyInput)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-bold">Salvar</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- APP PRINCIPAL ---

        function App() {
            // Estados de Dados
            const [docTitle, setDocTitle] = useState('');
            const [docRef, setDocRef] = useState('');
            const [docDate, setDocDate] = useState(new Date().toISOString().split('T')[0]);
            
            const [risks, setRisks] = useState([]);
            const [currentRisk, setCurrentRisk] = useState({ title: '', description: '', prob: 1, impact: 1 });
            
            const [actionPlans, setActionPlans] = useState([]);
            const [selectedRiskIdForAction, setSelectedRiskIdForAction] = useState('');
            const [conclusion, setConclusion] = useState('');

            // Estados de UI
            const [isGenerating, setIsGenerating] = useState(false);
            const [isGeneratingConclusion, setIsGeneratingConclusion] = useState(false);
            const [isPdfLibReady, setIsPdfLibReady] = useState(false);
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            const [apiKey, setApiKey] = useState(DEFAULT_API_KEY);
            
            // Modais e Toasts
            const [notification, setNotification] = useState(null); // { message, type }
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {} });
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);

            const contentRef = useRef(null);

            useEffect(() => {
                if (window.html2pdf) setIsPdfLibReady(true);
            }, []);

            // --- Helpers ---
            const showToast = (message, type = 'info') => setNotification({ message, type });
            const closeToast = () => setNotification(null);

            const openConfirm = (title, message, action) => {
                setConfirmModal({
                    isOpen: true,
                    title,
                    message,
                    onConfirm: () => {
                        action();
                        setConfirmModal({ ...confirmModal, isOpen: false });
                    }
                });
            };

            const calculateRiskLevel = (prob, impact) => prob * impact;
            
            const getRiskColor = (level) => {
                if (level <= 4) return 'bg-green-600 text-white border-green-800';
                if (level <= 9) return 'bg-yellow-500 text-slate-900 border-yellow-700';
                if (level <= 14) return 'bg-orange-500 text-white border-orange-700';
                return 'bg-red-600 text-white border-red-800';
            };

            const getRiskRowBgColor = (level) => {
                if (level <= 4) return 'bg-green-50 hover:bg-green-100';
                if (level <= 9) return 'bg-yellow-50 hover:bg-yellow-100';
                if (level <= 14) return 'bg-orange-50 hover:bg-orange-100';
                return 'bg-red-50 hover:bg-red-100';
            };

            const getMatrixCellColor = (level) => {
                if (level <= 4) return 'bg-green-600 hover:bg-green-500 text-white';
                if (level <= 9) return 'bg-yellow-400 hover:bg-yellow-300 text-slate-900';
                if (level <= 14) return 'bg-orange-500 hover:bg-orange-400 text-white';
                return 'bg-red-600 hover:bg-red-500 text-white';
            };

            const getRiskLabel = (level) => {
                if (level <= 4) return 'Baixo';
                if (level <= 9) return 'Médio';
                if (level <= 14) return 'Alto';
                return 'Extremo';
            };

            // --- Handlers ---
            const handleAddRisk = () => {
                if (!currentRisk.title || !currentRisk.description) {
                    showToast("Por favor, preencha o título e a descrição do risco.", "error");
                    return;
                }
                const newRisk = {
                    id: Date.now().toString(),
                    ...currentRisk,
                    level: calculateRiskLevel(currentRisk.prob, currentRisk.impact)
                };
                setRisks([...risks, newRisk]);
                setCurrentRisk({ title: '', description: '', prob: 1, impact: 1 });
                showToast("Risco adicionado com sucesso.", "success");
            };

            const handleDeleteRisk = (id) => {
                openConfirm(
                    "Excluir Risco",
                    "Tem certeza que deseja excluir este risco? O plano de ação associado também será removido.",
                    () => {
                        setRisks(risks.filter(r => r.id !== id));
                        setActionPlans(actionPlans.filter(ap => ap.riskId !== id));
                        showToast("Risco removido.", "success");
                    }
                );
            };

            const handleUpdateRisk = (id, field, value) => {
                // Atualização direta, sem necessidade de confirmação
                setRisks(risks.map(risk => {
                    if (risk.id === id) {
                        const updatedRisk = { ...risk, [field]: value };
                        if (field === 'prob' || field === 'impact') {
                            updatedRisk.level = calculateRiskLevel(updatedRisk.prob, updatedRisk.impact);
                        }
                        return updatedRisk;
                    }
                    return risk;
                }));
            };

            const handleUpdateActionPlan = (planId, field, value) => {
                setActionPlans(actionPlans.map(plan => 
                    plan.id === planId ? { ...plan, [field]: value } : plan
                ));
            };

            const handleClearAll = () => {
                openConfirm(
                    "Limpar Relatório",
                    "Isso apagará todos os riscos, planos de ação e conclusões. Esta ação não pode ser desfeita.",
                    () => {
                        setRisks([]);
                        setActionPlans([]);
                        setConclusion('');
                        setDocTitle('');
                        setDocRef('');
                        showToast("Relatório limpo.", "success");
                    }
                );
            };

            const handleGeneratePdf = () => {
                if (!isPdfLibReady || !window.html2pdf) {
                    showToast("Gerador de PDF carregando... Tente em instantes.", "info");
                    return;
                }

                setIsGeneratingPdf(true);
                const element = contentRef.current;
                
                const opt = {
                    margin:       [10, 10, 15, 10], 
                    filename:     `${docTitle || 'relatorio_inteligencia'}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    pagebreak:    { mode: ['css', 'legacy'] },
                    html2canvas:  { 
                        scale: 2, 
                        useCORS: true,
                        scrollY: 0, 
                        letterRendering: true,
                        backgroundColor: null,
                        onclone: (clonedDoc) => {
                            // Ocultar elementos marcados com 'no-print'
                            const elementsToHide = clonedDoc.querySelectorAll('.no-print');
                            elementsToHide.forEach(el => el.style.display = 'none');
                            
                            // Forçar quebra de página antes do plano de ação
                            const actionPlanSection = clonedDoc.getElementById('action-plan-section');
                            if (actionPlanSection) {
                                const breakDiv = clonedDoc.createElement('div');
                                breakDiv.style.pageBreakBefore = 'always';
                                breakDiv.style.breakBefore = 'page';
                                breakDiv.style.height = '1px';
                                breakDiv.style.display = 'block';
                                actionPlanSection.parentNode.insertBefore(breakDiv, actionPlanSection);
                            }

                            // Injeção de CSS específico para o PDF
                            const style = clonedDoc.createElement('style');
                            style.innerHTML = `
                                #pdf-root-container { background-color: white; }
                                #main-content { padding: 10px !important; gap: 5px !important; display: block !important; position: relative !important; z-index: 10 !important; }
                                #section-1-container { display: flex !important; flex-direction: row !important; gap: 10px !important; width: 100% !important; align-items: flex-start !important; }
                                #left-column { width: 40% !important; margin: 0 !important; }
                                #right-column { width: 60% !important; margin: 0 !important; }
                                #risks-table-container { margin: 0 !important; }
                                #matrix-container { margin: 0 !important; width: 100% !important; }
                                #action-plan-section { 
                                    display: block !important; 
                                    page-break-before: always !important; 
                                    break-before: page !important;
                                    margin-top: 0 !important;
                                    padding-top: 20px !important; 
                                    border-top: none !important; 
                                }
                                .overflow-x-auto { overflow: visible !important; display: block !important; width: 100% !important; }
                                table { font-size: 9px !important; width: 100% !important; page-break-inside: auto !important; background-color: white !important; }
                                thead { display: table-header-group !important; }
                                tr { page-break-inside: avoid !important; }
                                td, th { page-break-inside: avoid !important; }
                                h3, h4 { margin-top: 0 !important; margin-bottom: 5px !important; }
                                textarea { border: none !important; resize: none !important; padding: 0 !important; background: transparent !important; }
                                input { border: none !important; padding: 0 !important; background: transparent !important; }
                            `;
                            clonedDoc.body.appendChild(style);

                            // Transformar inputs e textareas em texto estático para melhor renderização
                            const inputs = clonedDoc.querySelectorAll('input');
                            inputs.forEach(input => {
                                if(input.type === 'text' || input.type === 'date') {
                                    input.style.border = 'none';
                                    input.style.padding = '0';
                                    input.style.backgroundColor = 'transparent';
                                }
                            });

                            const textareas = clonedDoc.querySelectorAll('textarea');
                            textareas.forEach(ta => {
                                const div = document.createElement('div');
                                div.innerText = ta.value;
                                div.style.whiteSpace = 'pre-wrap';
                                div.style.wordWrap = 'break-word';
                                div.style.fontSize = window.getComputedStyle(ta).fontSize;
                                div.style.fontFamily = window.getComputedStyle(ta).fontFamily;
                                div.style.textAlign = window.getComputedStyle(ta).textAlign;
                                div.style.width = '100%';
                                if (ta.closest('td')) { div.style.overflow = 'visible'; }
                                ta.parentNode.replaceChild(div, ta);
                            });
                            
                            const inputForm = clonedDoc.getElementById('risk-input-form');
                            if (inputForm) inputForm.remove(); 

                            // Ajuste forçado de layout para a matriz
                            const matrixContainer = clonedDoc.getElementById('matrix-container');
                            if (matrixContainer) {
                                matrixContainer.style.width = '100%';
                                matrixContainer.style.maxWidth = '100%';
                                matrixContainer.style.marginTop = '20px'; 
                                matrixContainer.style.paddingTop = '0px';
                                matrixContainer.style.display = 'block';
                            }
                        }
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                window.html2pdf().from(element).set(opt).toPdf().get('pdf').then((pdf) => {
                    const totalPages = pdf.internal.getNumberOfPages();
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    
                    for (let i = 1; i <= totalPages; i++) {
                        pdf.setPage(i);
                        pdf.setFontSize(8);
                        pdf.setTextColor(180, 0, 0); 
                        pdf.text('DOCUMENTO PREPARATÓRIO - ACESSO RESTRITO', pageWidth / 2, pageHeight - 8, { align: 'center' });
                    }
                }).save().then(() => {
                    setIsGeneratingPdf(false);
                    showToast("PDF gerado com sucesso!", "success");
                }).catch(err => {
                    console.error(err);
                    setIsGeneratingPdf(false);
                    showToast("Erro ao gerar PDF. Verifique o console.", "error");
                });
            };

            const generateActionPlan = async () => {
                if (!apiKey) {
                    setIsSettingsOpen(true);
                    showToast("Insira sua API Key para usar a IA", "info");
                    return;
                }
                if (!selectedRiskIdForAction) return;
                
                setIsGenerating(true);
                const riskToAnalyze = risks.find(r => r.id === selectedRiskIdForAction);
                try {
                    const prompt = `Aja como um especialista em Inteligência Penitenciária e Gestão de Riscos. Crie um plano de ação 5W2H conciso (máx 140 caracteres por campo) para o seguinte risco identificado em ambiente prisional: "${riskToAnalyze.title}" - Descrição: ${riskToAnalyze.description} (Nível de Risco: ${getRiskLabel(riskToAnalyze.level)}). Retorne APENAS um JSON válido com as chaves: "what", "why", "where", "when", "who", "how", "how_much". Sem markdown, apenas o JSON raw.`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `Erro HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("Resposta da IA vazia");
                    
                    // Limpeza extra caso venha com markdown
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const plan = JSON.parse(text);
                    
                    setActionPlans([...actionPlans, { id: Date.now().toString(), riskId: riskToAnalyze.id, riskTitle: riskToAnalyze.title, ...plan }]);
                    setSelectedRiskIdForAction('');
                    showToast("Plano de Ação gerado!", "success");

                } catch (error) { 
                    console.error("Erro IA:", error); 
                    showToast(`Erro na IA: ${error.message}`, "error"); 
                } finally { 
                    setIsGenerating(false); 
                }
            };

            const generateConclusion = async () => {
                if (!apiKey) {
                    setIsSettingsOpen(true);
                    showToast("Insira sua API Key para usar a IA", "info");
                    return;
                }
                if (risks.length === 0) return;
                setIsGeneratingConclusion(true);
                try {
                    const risksText = risks.map(r => `- ${r.title} (Nível: ${getRiskLabel(r.level)})`).join('\n');
                    const actionsText = actionPlans.map(a => `- Ação para ${a.riskTitle}: ${a.what}`).join('\n');
                    const prompt = `Escreva uma conclusão técnica e formal para um Relatório de Inteligência Penitenciária. Título do documento: ${docTitle}. \nRiscos Identificados:\n${risksText}\n\nAções Propostas:\n${actionsText}\n\nEscreva um parágrafo único, conciso, focado na mitigação e controle da ordem.`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `Erro HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("Resposta da IA vazia");
                    setConclusion(text);
                    showToast("Conclusão gerada!", "success");

                } catch (error) { 
                    console.error("Erro IA:", error); 
                    showToast(`Erro na IA: ${error.message}`, "error"); 
                } finally { 
                    setIsGeneratingConclusion(false); 
                }
            };

            return (
                <div className="min-h-screen bg-gray-200 p-4 md:p-8 font-sans text-slate-800 flex justify-center">
                    
                    {/* Botão Flutuante de Configurações */}
                    <button 
                        onClick={() => setIsSettingsOpen(true)}
                        className="fixed top-4 right-4 z-40 bg-white p-2 rounded-full shadow-md text-slate-500 hover:text-blue-600 hover:rotate-90 transition duration-300 no-print"
                        title="Configurações (API Key)"
                    >
                        <Settings size={20} />
                    </button>

                    {/* Componentes de UI Globais */}
                    {notification && <Toast message={notification.message} type={notification.type} onClose={closeToast} />}
                    
                    <ConfirmModal 
                        isOpen={confirmModal.isOpen} 
                        title={confirmModal.title} 
                        message={confirmModal.message} 
                        onConfirm={confirmModal.onConfirm} 
                        onCancel={() => setConfirmModal({ ...confirmModal, isOpen: false })} 
                    />

                    <SettingsModal 
                        isOpen={isSettingsOpen}
                        currentKey={apiKey}
                        onSave={(key) => { setApiKey(key); setIsSettingsOpen(false); showToast("Chave salva temporariamente!", "success"); }}
                        onClose={() => setIsSettingsOpen(false)}
                    />

                    {/* Área do Documento (A4) */}
                    <div ref={contentRef} className="w-full max-w-[21cm] bg-white shadow-2xl min-h-[29.7cm] relative z-10 p-0 overflow-hidden" id="pdf-root-container">
                        
                        <header className="border-b-4 border-yellow-500 p-8 flex flex-col items-center justify-center gap-1 text-center relative z-20">
                            <h1 className="text-xl md:text-2xl font-extrabold text-slate-900 uppercase tracking-widest">
                                Polícia Penal do Rio Grande do Sul
                            </h1>
                            <h2 className="text-base md:text-lg font-bold text-slate-700 uppercase tracking-wide">
                                Departamento de Inteligência
                            </h2>
                            <h3 className="text-sm md:text-base font-medium text-slate-600 uppercase border-t border-slate-300 pt-1 w-full max-w-lg mt-2">
                                Ferramenta de Análise de Risco
                            </h3>
                        </header>

                        <div className="p-8 bg-slate-50 border-b border-slate-200 relative z-20">
                            <div className="grid grid-cols-1 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Título do Documento / Operação</label>
                                    <input 
                                        type="text" 
                                        value={docTitle}
                                        onChange={(e) => setDocTitle(e.target.value)}
                                        placeholder="Ex: Operação Muralha"
                                        className="w-full p-2 border border-slate-300 rounded focus:border-blue-600 outline-none bg-white font-bold text-lg text-slate-800"
                                    />
                                </div>
                                <div className="grid grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Documento de Referência</label>
                                        <input 
                                            type="text" 
                                            value={docRef}
                                            onChange={(e) => setDocRef(e.target.value)}
                                            placeholder="Ex: RELINT Nº XXXX-2025"
                                            className="w-full p-2 border border-slate-300 rounded focus:border-blue-600 outline-none bg-white text-sm"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Data da Produção</label>
                                        <input 
                                            type="date" 
                                            value={docDate}
                                            onChange={(e) => setDocDate(e.target.value)}
                                            className="w-full p-2 border border-slate-300 rounded focus:border-blue-600 outline-none bg-white text-sm font-medium"
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <main id="main-content" className="p-8 space-y-6 relative z-20">
                            
                            <section id="matrix-section">
                                <div id="matrix-header" className="flex items-center gap-2 mb-4 border-b border-slate-300">
                                    <ShieldAlert className="w-5 h-5 text-blue-800" />
                                    <h3 className="text-base font-bold text-slate-800 uppercase py-1">1. Análise de Risco</h3>
                                </div>

                                <div id="section-1-container" className="flex flex-col xl:flex-row gap-6 items-start">
                                    
                                    <div id="left-column" className="w-full xl:w-5/12 flex flex-col gap-4">
                                        
                                        <div id="risks-table-container">
                                            <h4 className="text-xs font-bold text-slate-700 uppercase mb-2 border-b border-slate-200">Riscos Identificados</h4>
                                            <div className="overflow-x-auto rounded border border-slate-200">
                                            <table className="w-full text-xs text-left text-slate-700">
                                                <thead className="bg-slate-100 uppercase font-bold text-[10px]">
                                                <tr>
                                                    <th className="px-2 py-2 border-b">Título / Descrição</th>
                                                    <th className="px-2 py-2 border-b w-10 text-center">P</th>
                                                    <th className="px-2 py-2 border-b w-10 text-center">I</th>
                                                    <th className="px-2 py-2 border-b text-center w-8 no-print">X</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                {risks.length === 0 && (
                                                    <tr><td colSpan="5" className="px-2 py-6 text-center text-slate-400 text-[10px]">Nenhum risco registrado.</td></tr>
                                                )}
                                                {risks.map((risk) => (
                                                    <tr key={risk.id} className={`border-b ${getRiskRowBgColor(risk.level)} text-[10px]`}>
                                                    <td className="px-2 py-2 align-top">
                                                        <div className="font-bold text-slate-800">{risk.title}</div>
                                                        <div className="text-slate-600 text-[9px] mt-0.5 leading-tight">{risk.description}</div>
                                                    </td>
                                                    <td className="px-1 py-2 align-top text-center font-bold">
                                                        {risk.prob}
                                                    </td>
                                                    <td className="px-1 py-2 align-top text-center font-bold">
                                                        {risk.impact}
                                                    </td>
                                                    <td className="px-2 py-2 text-center no-print align-top">
                                                        <button onClick={() => handleDeleteRisk(risk.id)} className="text-red-500 hover:text-red-700 transition"><Trash2 size={14} /></button>
                                                    </td>
                                                    </tr>
                                                ))}
                                                </tbody>
                                            </table>
                                            </div>
                                        </div>

                                        <div id="risk-input-form" className="bg-blue-50 p-4 rounded-lg border border-blue-100 no-print shadow-sm">
                                            <h4 className="font-bold text-blue-900 mb-3 text-xs uppercase flex items-center gap-2">
                                                <Plus size={16} /> Adicionar Novo Risco
                                            </h4>
                                            
                                            <div className="space-y-3">
                                                <div>
                                                    <input 
                                                        type="text"
                                                        value={currentRisk.title}
                                                        onChange={(e) => setCurrentRisk({...currentRisk, title: e.target.value})}
                                                        placeholder="Título (Ex: Fuga em Massa)"
                                                        maxLength={40}
                                                        className="w-full p-2 text-xs border border-blue-200 rounded outline-none focus:border-blue-400"
                                                    />
                                                </div>
                                                <div>
                                                    <textarea 
                                                        value={currentRisk.description}
                                                        onChange={(e) => setCurrentRisk({...currentRisk, description: e.target.value})}
                                                        placeholder="Breve descrição do cenário..."
                                                        className="w-full p-2 text-xs border border-blue-200 rounded resize-none h-16 outline-none focus:border-blue-400"
                                                    />
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="block text-[9px] font-bold text-blue-800 mb-1 uppercase">Probabilidade</label>
                                                        <select 
                                                            value={currentRisk.prob}
                                                            onChange={(e) => setCurrentRisk({...currentRisk, prob: parseInt(e.target.value)})}
                                                            className="w-full p-1.5 text-xs border border-blue-200 rounded bg-white outline-none"
                                                        >
                                                            {PROBABILITY_OPTIONS.map(([val, label]) => <option key={val} value={val}>{val} - {label}</option>)}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-[9px] font-bold text-blue-800 mb-1 uppercase">Impacto</label>
                                                        <select 
                                                            value={currentRisk.impact}
                                                            onChange={(e) => setCurrentRisk({...currentRisk, impact: parseInt(e.target.value)})}
                                                            className="w-full p-1.5 text-xs border border-blue-200 rounded bg-white outline-none"
                                                        >
                                                            {IMPACT_OPTIONS.map(([val, label]) => <option key={val} value={val}>{val} - {label}</option>)}
                                                        </select>
                                                    </div>
                                                </div>
                                                <button onClick={handleAddRisk} className="w-full bg-blue-800 hover:bg-blue-900 text-white font-bold py-2 px-3 rounded uppercase text-[10px] shadow-sm mt-1 transition">Adicionar Risco</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="right-column" className="w-full xl:w-7/12">
                                        <div id="matrix-container" className="flex flex-col items-center justify-start w-full">
                                            <h4 className="text-xs font-bold text-slate-700 uppercase mb-2 w-full text-center border-b border-slate-200 pb-1">MATRIZ DE RISCO</h4>
                                            
                                            <div className="flex flex-row items-center justify-center w-full">
                                                <div className="h-64 flex items-center justify-center mr-2 w-4">
                                                    <span className="-rotate-90 whitespace-nowrap text-[9px] font-black uppercase tracking-widest text-slate-800">
                                                    Probabilidade
                                                    </span>
                                                </div>
                                                <div className="flex flex-col justify-between h-[300px] mr-2 text-[9px] font-bold text-slate-600 text-right py-4 w-20">
                                                    {PROBABILITY_OPTIONS.map(([val, label]) => (
                                                        <div key={val} className="flex items-center justify-end h-full leading-tight">{label}</div>
                                                    ))}
                                                </div>
                                                
                                                <div className="relative w-full aspect-square max-w-[300px]">
                                                    <div className="grid grid-cols-5 gap-0.5 bg-slate-800 border-2 border-slate-800 p-0.5 w-full h-[300px] shadow-sm rounded-sm overflow-hidden">
                                                    {[5, 4, 3, 2, 1].map((prob) => (
                                                        <React.Fragment key={prob}>
                                                        {[1, 2, 3, 4, 5].map((impact) => {
                                                            const level = prob * impact;
                                                            const cellRisks = risks.filter(r => r.prob === prob && r.impact === impact);
                                                            const bgColor = getMatrixCellColor(level);
                                                            return (
                                                            <div key={`${prob}-${impact}`} className={`relative flex flex-col items-center justify-start p-0.5 text-[8px] font-bold ${bgColor} overflow-hidden group hover:opacity-90 transition`}>
                                                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-20 z-0">
                                                                <span className="text-2xl font-black text-black/50 mix-blend-overlay">{level}</span>
                                                                </div>
                                                                {cellRisks.length > 0 && (
                                                                <div className="w-full flex flex-col gap-0.5 z-10 relative h-full overflow-hidden p-0.5">
                                                                    {cellRisks.map((risk, idx) => (
                                                                    <div key={idx} className="bg-slate-900/90 text-white px-0.5 py-0.5 rounded text-[7px] font-bold leading-tight text-center break-words w-full shadow-sm">
                                                                        {risk.title}
                                                                    </div>
                                                                    ))}
                                                                </div>
                                                                )}
                                                            </div>
                                                            );
                                                        })}
                                                        </React.Fragment>
                                                    ))}
                                                    </div>
                                                    <div className="grid grid-cols-5 mt-1 text-center text-[9px] font-bold text-slate-600 w-full">
                                                        {IMPACT_OPTIONS.map(([val, label]) => (
                                                            <div key={val} className="flex flex-col items-center justify-start h-8 px-1">
                                                                <span className="leading-tight">{label}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="mt-1 text-center w-full pl-6">
                                                <span className="text-[9px] font-black uppercase tracking-widest text-slate-800">Impacto</span>
                                            </div>

                                            <div className="flex flex-wrap justify-center gap-4 mt-6 text-[10px] font-bold uppercase bg-white p-3 rounded-full shadow-sm border border-slate-200">
                                                <div className="flex items-center gap-1.5"><div className="w-3 h-3 bg-green-600 rounded-full"></div> Baixo (1-4)</div>
                                                <div className="flex items-center gap-1.5"><div className="w-3 h-3 bg-yellow-400 rounded-full"></div> Médio (5-9)</div>
                                                <div className="flex items-center gap-1.5"><div className="w-3 h-3 bg-orange-500 rounded-full"></div> Alto (10-14)</div>
                                                <div className="flex items-center gap-1.5"><div className="w-3 h-3 bg-red-600 rounded-full"></div> Extremo (15-25)</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section id="action-plan-section" className="mt-8 pt-4 border-t border-slate-300">
                                <div id="action-plan-header" className="flex items-center gap-2 mb-4 border-b pb-1 border-slate-300">
                                    <CheckCircle2 className="w-5 h-5 text-blue-800" />
                                    <h3 className="text-base font-bold text-slate-800 uppercase">2. Plano de Ação (5W2H)</h3>
                                </div>

                                <div className="bg-slate-50 p-3 rounded border border-slate-200 mb-4 flex flex-col md:flex-row gap-3 items-center no-print shadow-sm">
                                    <div className="flex-grow w-full">
                                        <select value={selectedRiskIdForAction} onChange={(e) => setSelectedRiskIdForAction(e.target.value)} className="w-full p-2 text-xs border rounded bg-white outline-none">
                                                <option value="">-- Selecione um Risco para gerar o Plano --</option>
                                                {risks.filter(r => !actionPlans.some(ap => ap.riskId === r.id)).map(r => <option key={r.id} value={r.id}>{r.title}</option>)}
                                        </select>
                                    </div>
                                    <button onClick={generateActionPlan} disabled={!selectedRiskIdForAction || isGenerating} className="w-full md:w-auto py-2 px-6 rounded text-white font-bold bg-indigo-600 hover:bg-indigo-700 text-xs flex justify-center items-center gap-2 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                        {isGenerating ? <RefreshCw className="animate-spin" size={14} /> : <BrainCircuit size={14} />}
                                        {isGenerating ? 'Gerando...' : 'Gerar com IA'}
                                    </button>
                                </div>

                                <div className="overflow-x-auto rounded border border-slate-200 bg-white">
                                    {actionPlans.length === 0 ? (
                                        <div className="text-center py-8 bg-slate-50 text-slate-400 italic text-xs">Nenhum plano de ação gerado. Selecione um risco acima e use a IA.</div>
                                    ) : (
                                        <table className="w-full text-[10px] text-left text-slate-700">
                                            <thead className="bg-slate-100 uppercase font-bold text-slate-800">
                                            <tr>
                                                <th className="px-3 py-2 border-b border-r bg-slate-200 w-24 text-center">Fator 5W2H</th>
                                                {actionPlans.map((plan) => (
                                                    <th key={plan.id} className="px-3 py-2 border-b border-r min-w-[140px] bg-slate-50">
                                                    <div className="flex justify-between items-center text-blue-900">
                                                        <span>{plan.riskTitle}</span>
                                                        <button onClick={() => handleDeleteRisk(plan.riskId)} className="text-red-400 hover:text-red-600 no-print"><Trash2 size={12} /></button>
                                                    </div>
                                                    </th>
                                                ))}
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {W2H_QUESTIONS.map((question, qIdx) => (
                                                <tr key={question.key} className={qIdx % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}>
                                                    <td className="px-3 py-2 border-b border-r font-bold bg-slate-100 text-center text-slate-600">{question.label}</td>
                                                    {actionPlans.map((plan) => (
                                                        <td key={`${plan.id}-${question.key}`} className="px-3 py-1 border-b border-r align-top">
                                                            <textarea
                                                                value={plan[question.key]}
                                                                onChange={(e) => handleUpdateActionPlan(plan.id, question.key, e.target.value)}
                                                                maxLength={200}
                                                                className="w-full bg-transparent outline-none resize-none overflow-hidden text-[10px] leading-tight focus:bg-yellow-50 transition"
                                                                rows={2}
                                                                style={{ minHeight: '24px' }}
                                                                onInput={(e) => { e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; }}
                                                            />
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                            </tbody>
                                        </table>
                                    )}
                                </div>
                            </section>

                            <section className="mt-8 pt-4 border-t border-slate-300" style={{ pageBreakInside: 'avoid' }}>
                                <div className="flex items-center gap-2 mb-4 border-b pb-1 border-slate-300">
                                    <FileText className="w-5 h-5 text-blue-800" />
                                    <h3 className="text-base font-bold text-slate-800 uppercase">3. Conclusão</h3>
                                </div>
                                <div className="relative group">
                                    <textarea 
                                            value={conclusion}
                                            onChange={(e) => setConclusion(e.target.value)}
                                            placeholder="Aguardando geração da conclusão ou insira manualmente..."
                                            className="w-full p-4 border border-slate-300 rounded text-justify text-xs leading-relaxed bg-white min-h-[120px] focus:border-blue-500 outline-none"
                                    />
                                    <div className="absolute bottom-3 right-3 no-print opacity-100 transition-opacity">
                                        <button 
                                            onClick={generateConclusion} 
                                            disabled={isGeneratingConclusion || risks.length === 0} 
                                            className="bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-bold py-1.5 px-3 rounded flex gap-1 items-center shadow disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {isGeneratingConclusion ? <RefreshCw className="animate-spin" size={12} /> : <BrainCircuit size={12} />}
                                            Gerar Texto
                                        </button>
                                    </div>
                                </div>
                            </section>

                        </main>
                        
                        <footer className="bg-slate-800 text-white p-4 no-print flex justify-between items-center mt-auto border-t-4 border-yellow-500">
                            <button onClick={handleClearAll} className="flex items-center gap-2 text-red-300 hover:text-red-100 text-xs font-bold uppercase transition">
                                <Eraser size={16} /> Limpar Tudo
                            </button>
                            
                            <div className="flex gap-4">
                                <div className="text-[10px] text-slate-400 flex flex-col items-end justify-center text-right">
                                    <span>Sistema de Análise de Risco</span>
                                    <span>Versão 1.2 - Inteligência</span>
                                </div>
                                <button onClick={handleGeneratePdf} disabled={isGeneratingPdf} className="flex items-center gap-2 bg-yellow-500 hover:bg-yellow-400 text-slate-900 font-bold px-6 py-2 rounded text-sm uppercase disabled:opacity-50 transition shadow-lg">
                                    {isGeneratingPdf ? <RefreshCw className="animate-spin" size={18} /> : <Download size={18} />} 
                                    {isGeneratingPdf ? 'Gerando PDF...' : 'Baixar PDF'}
                                </button>
                            </div>
                        </footer>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
